
# ============================================
# STEP 4: Auth Service Policies
# ============================================

---
# Auth Service: Allow ingress from gateway and services
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-service-ingress
  namespace: services
spec:
  podSelector:
    matchLabels:
      app: auth-service
  policyTypes:
  - Ingress
  ingress:
  # From API Gateway
  - from:
    - namespaceSelector:
        matchLabels:
          name: gateway
      podSelector:
        matchLabels:
          app: api-gateway
    ports:
    - protocol: TCP
      port: 8001
    - protocol: TCP
      port: 50051
  # From other services in same namespace (for gRPC)
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 8001
    - protocol: TCP
      port: 50051
  # From internal namespace (tokenization needs auth)
  - from:
    - namespaceSelector:
        matchLabels:
          name: internal
    ports:
    - protocol: TCP
      port: 8001

---
# Auth Service: Allow egress to databases
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-service-egress
  namespace: services
spec:
  podSelector:
    matchLabels:
      app: auth-service
  policyTypes:
  - Egress
  egress:
  # To databases
  - to:
    - namespaceSelector:
        matchLabels:
          name: databases
    ports:
    - protocol: TCP
      port: 5432  # PostgreSQL
    - protocol: TCP
      port: 6379  # Redis
  # DNS already allowed above
