apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-bootstrap
  namespace: databases
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: postgres-bootstrap
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "database-service"
        vault.hashicorp.com/agent-inject-secret-admin-dsn: "secret/data/database/admin-dsn"
        vault.hashicorp.com/agent-inject-template-admin-dsn: |
          {{- with secret "secret/data/database/admin-dsn" -}}
          {{ .Data.data.value }}
          {{- end }}
    spec:
      serviceAccountName: database-service
      restartPolicy: OnFailure
      containers:
      - name: bootstrap
        image: postgres:15-alpine
        command:
          - sh
          - -c
          - |
            # Read the DSN from the vault secret file
            export DATABASE_DSN=$(cat /vault/secrets/admin-dsn)
            
            # Create databases
            psql "$DATABASE_DSN" <<EOF
            CREATE DATABASE IF NOT EXISTS micro_auth;
            CREATE DATABASE IF NOT EXISTS micro_merchant;
            CREATE DATABASE IF NOT EXISTS micro_payment;
            CREATE DATABASE IF NOT EXISTS micro_tokenization;
            CREATE DATABASE IF NOT EXISTS micro_transaction;
            EOF
            
            echo "âœ… Databases created successfully"
        env:
        - name: VAULT_ADDR
          value: "http://vault.vault.svc.cluster.local:8200"