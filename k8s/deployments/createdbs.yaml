apiVersion: batch/v1
kind: Job
metadata:
  name: postgres-bootstrap
  namespace: databases
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: postgres-bootstrap
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "database-service"
        vault.hashicorp.com/agent-inject-env: "VAULT_ADDR"
        vault.hashicorp.com/agent-inject-secret-admin-dsn: "secret/data/database/admin-dsn"
        vault.hashicorp.com/agent-inject-template-admin-dsn: |
          {{- with secret "secret/data/database/admin-dsn" -}}
          {{ .Data.data.value }}
          {{- end }}
    spec:
      serviceAccountName: database-service
      restartPolicy: OnFailure
      containers:
      - name: bootstrap
        image: postgres:15-alpine
        command:
          - sh
          - -c
          - |
            psql "$DATABASE_DSN" <<EOF
            CREATE DATABASE micro_auth;
            CREATE DATABASE micro_merchant;
            CREATE DATABASE micro_payment;
            CREATE DATABASE micro_tokenization;
            CREATE DATABASE micro_transaction;
            EOF
        env:
        - name: DATABASE_DSN
          value: "file:///vault/secrets/admin-dsn"
        - name: VAULT_ADDR
          value: "http://vault.vault.svc.cluster.local:8200"