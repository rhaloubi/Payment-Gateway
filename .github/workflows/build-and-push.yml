name: Build & Push Docker Images

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  build-api-gateway:
    name: Build API Gateway
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./api-gateway
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-api:cache
          cache-to: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-api:cache,mode=max  
          file: ./api-gateway/dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-api:latest
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-api:${{ github.sha }}

  build-auth-service:
    name: Build Auth Service
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./auth-service
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-auth:cache
          cache-to: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-auth:cache,mode=max  
          file: ./auth-service/dockerfile
          platforms: linux/amd64,linux/arm64   
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-auth:latest
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-auth:${{ github.sha }}

  build-merchant-service:
    name: Build Merchant Service
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./merchant-service
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-merchant:cache
          cache-to: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-merchant:cache,mode=max  
          file: ./merchant-service/dockerfile
          platforms: linux/amd64,linux/arm64   
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-merchant:latest
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-merchant:${{ github.sha }}

  build-payment-api-service:
    name: Build Payment API Service
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./payment-api-service
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-payment-api:cache
          cache-to: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-payment-api:cache,mode=max  
          file: ./payment-api-service/dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-payment-api:latest
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-payment-api:${{ github.sha }}

  build-tokenization-service:
    name: Build Tokenization Service
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./tokenization-service
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-tokenization:cache
          cache-to: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-tokenization:cache,mode=max  
          file: ./tokenization-service/dockerfile
          platforms: linux/amd64,linux/arm64   
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-tokenization:latest
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-tokenization:${{ github.sha }}

  build-transaction-service:
    name: Build Transaction Service
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./transaction-service
          cache-from: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-transaction:cache
          cache-to: type=registry,ref=${{ env.DOCKERHUB_USERNAME }}/payment-gateway-transaction:cache,mode=max  
          file: ./transaction-service/dockerfile
          platforms: linux/amd64,linux/arm64   
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-transaction:latest
            ${{ env.DOCKERHUB_USERNAME }}/payment-gateway-transaction:${{ github.sha }}

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-api-gateway, build-auth-service, build-merchant-service, build-payment-api-service, build-tokenization-service, build-transaction-service]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "âœ… Docker images built and pushed!"
          echo "Check: https://hub.docker.com/u/${{ env.DOCKERHUB_USERNAME }}"
