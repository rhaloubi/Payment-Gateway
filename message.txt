# ğŸ¦ Payment Gateway Microservices - Project Context

## ğŸ“Œ Project Overview

**Purpose:** Educational fintech payment gateway with multi-tenant, PCI-DSS-aware microservices architecture.

**Tech Stack:**
- **Backend:** Go 1.23+
- **Database:** PostgreSQL (with TDE encryption)
- **Cache:** Redis
- **Message Broker:** Apache Kafka
- **Secret Management:** HashiCorp Vault (dev mode)
- **Communication:** REST (public), gRPC (internal)

---

## ğŸ—ï¸ Implemented Services

### 1. **Auth Service** âœ… (Port 8001)

**Purpose:** Authentication, authorization, API key management

**Features:**
- âœ… User registration/login (JWT tokens)
- âœ… Access tokens (15 min) + Refresh tokens (7 days)
- âœ… API key management (HMAC-SHA256)
- âœ… Role-Based Access Control (RBAC)
- âœ… Permissions (read, create, update, delete)
- âœ… Multi-tenant support
- âœ… Account security (lockout after 5 failed attempts)
- âœ… Redis caching (15 min TTL)

**Database Tables:**
```sql
users
roles (Owner, Admin, Manager, Staff)
permissions
user_roles
role_permissions
sessions
api_keys
```

**Endpoints:**
```
POST   /api/v1/auth/register
POST   /api/v1/auth/login
POST   /api/v1/auth/refresh
POST   /api/v1/auth/logout
GET    /api/v1/auth/profile
POST   /api/v1/auth/change-password

GET    /api/v1/roles
POST   /api/v1/roles/assign
DELETE /api/v1/roles/assign

POST   /api/v1/api-keys
GET    /api/v1/api-keys/merchant/:merchant_id
DELETE /api/v1/api-keys/:id
```

---

### 2. **Merchant Service** âœ… (Port 8002)

**Purpose:** Merchant onboarding, team management, business configuration

**Features:**
- âœ… Merchant registration (KYC)
- âœ… Business info management
- âœ… Team invitations (email-based)
- âœ… Role assignment (Owner, Admin, Manager, Staff)
- âœ… Permission enforcement per role
- âœ… Settings management
- âœ… Activity logging (audit trail)
- âœ… Multi-tenant isolation

**Database Tables:**
```sql
merchants
merchant_users
merchant_invitations
merchant_settings
merchant_business_info
merchant_branding
merchant_verification
merchant_activity_logs
```

**Endpoints:**
```
POST   /api/v1/merchants
GET    /api/v1/merchants
GET    /api/v1/merchants/:id
PATCH  /api/v1/merchants/:id
DELETE /api/v1/merchants/:id

POST   /api/v1/merchants/:id/team/invite
GET    /api/v1/merchants/:id/team
PATCH  /api/v1/merchants/:id/team/:user_id
DELETE /api/v1/merchants/:id/team/:user_id

GET    /api/v1/merchants/:id/settings
PATCH  /api/v1/merchants/:id/settings
```

**Role Permissions:**

| Role    | Read | Create | Update | Delete |
|---------|------|--------|--------|--------|
| Owner   | âœ…   | âœ…     | âœ…     | âœ…     |
| Admin   | âœ…   | âœ…     | âœ…     | âŒ     |
| Manager | âœ…   | âœ…     | âŒ     | âŒ     |
| Staff   | âœ…   | âŒ     | âŒ     | âŒ     |

---

### 3. **Tokenization Service** â³ (Port 8003)

**Purpose:** Secure card tokenization (PCI scope reduction)

**Features:**
- âœ… Card validation (Luhn, expiry, CVV)
- âœ… Card brand detection (Visa, MC, Amex, Discover, Diners, JCB)
- âœ… AES-256-GCM encryption (field-level)
- âœ… Per-merchant encryption keys (DEK)
- âœ… Duplicate detection (SHA-256 fingerprinting)
- âœ… Token generation (tok_live_xxx)
- âœ… BIN database (card type, issuer info)
- âœ… Single-use token support
- âœ… Token lifecycle (active, expired, revoked, used)
- âœ… Usage tracking & audit logging
- â³ REST handlers (in progress)
- â³ gRPC handlers (pending)

**Database Tables:**
```sql
card_vault
tokenization_requests
token_usage_logs
encryption_key_metadata
card_bin_info
```

**Services Implemented:**
```go
âœ… TokenizationService
   - TokenizeCard()
   - Detokenize()
   - ValidateToken()
   - RevokeToken()
   - GetTokenInfo()

âœ… KeyManagementService
   - GetOrCreateMerchantKey()
   - RotateMerchantKey()
   - RevokeKey()
   - CheckKeyRotationNeeded()

âœ… CardValidationService
   - ValidateCard()
   - DetectCardBrand()
   - ValidateLuhn()
   - ValidateExpiry()
   - ValidateCVV()

âœ… EncryptionService
   - Encrypt()
   - Decrypt()
   - EncryptCardData()
   - DecryptCardData()
   - GenerateCardFingerprint()
```

**Pending:**
```
â³ REST API handlers
â³ gRPC handlers (for internal services)
â³ Middleware (auth, rate limit, logging)
â³ Routes setup
```

---

## ğŸ”„ Payment Flow

### **User Journey:**
```
1. User creates account â†’ [Auth Service]
   â†“
2. User creates merchant â†’ [Merchant Service]
   â†“
3. Merchant integrates API â†’ Get API keys [Auth Service]
   â†“
4. Buyer enters card on payment page
   â†“
5. Card sent to Payment API â†’ [Payment API Service] â³
   â†“
6. Tokenize card â†’ [Tokenization Service] â³
   â†“
7. Check fraud â†’ [Fraud Detection Service] â³
   â†“
8. Process transaction â†’ [Transaction Service] â³
   â†“
9. Simulate issuer response â†’ [Card Simulator] â³
   â†“
10. Return response to merchant
    â†“
11. Send webhook notification â†’ [Webhook Service] â³
```

---

## ğŸ¯ Services to Build Next

### **Priority 1: Core Payment Processing**

1. **Payment API Service** (Public Gateway)
   - REST API for merchants
   - API key authentication
   - Rate limiting
   - Idempotency
   - Routes to internal services

2. **Transaction Service** (Internal)
   - Process authorization
   - Process capture
   - Process void
   - Process refund
   - Transaction state machine
   - Event publishing (Kafka)

3. **Fraud Detection Service** (Internal)
   - Velocity checks
   - Amount thresholds
   - Risk scoring
   - Decision engine

4. **Card Simulator Service** (Testing)
   - Simulate issuer responses
   - Test card patterns
   - Configurable scenarios

---

## ğŸ” Security Architecture

### **Encryption:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HashiCorp Vault (KEK)              â”‚
â”‚   Master Encryption Key              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ DEK 1  â”‚      â”‚ DEK 2   â”‚  (Per-merchant)
â”‚Merchantâ”‚      â”‚Merchant â”‚
â”‚  123   â”‚      â”‚  456    â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚                â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚   Encrypted Card Data    â”‚
â”‚   (PostgreSQL Database)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Token Format:**
```
Production: tok_live_4xJ3kL9mN2pQ5rT8vW1yZ4bC7dE0fG
Test:       tok_test_1aB2cD3eF4gH5iJ6kL7mN8oP9qR0sT
```

### **PCI Compliance Rules:**
```
âœ… Encrypt card data at rest (AES-256-GCM)
âœ… Encrypt card data in transit (TLS 1.3)
âœ… Never log full PAN (only last 4 digits)
âœ… Never store CVV (validate but discard)
âœ… Use per-merchant encryption keys
âœ… Audit all access to cardholder data
âœ… Implement key rotation (90 days)
âœ… Mask card numbers in logs (****1234)
```

---

## ğŸ“¡ Service Communication

### **Public (REST):**
```
Merchant â†’ Payment API Service (REST)
```

### **Internal (gRPC):**
```
Payment API â†â†’ Tokenization Service
Payment API â†â†’ Transaction Service
Payment API â†â†’ Fraud Service
Transaction â†â†’ Tokenization Service
Transaction â†â†’ Card Simulator
```

---

## ğŸ§ª Test Cards

| Card Number          | Response                | Code |
|---------------------|-------------------------|------|
| 4242 4242 4242 4242 | âœ… Approved             | 00   |
| 4000 0000 0000 0002 | âŒ Generic decline      | 05   |
| 4000 0000 0000 9995 | âŒ Insufficient funds   | 51   |
| 4000 0000 0000 0069 | âŒ Expired card         | 54   |
| 4000 0000 0000 0127 | âŒ Incorrect CVV        | N7   |

---

## ğŸ“¦ Project Structure
```
payment-gateway/
â”œâ”€â”€ auth-service/
â”‚   â”œâ”€â”€ cmd/main.go
â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â””â”€â”€ api/routes.go
â”‚   â””â”€â”€ migrations/
â”‚
â”œâ”€â”€ merchant-service/
â”‚   â”œâ”€â”€ cmd/main.go
â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ client/ (auth_client.go)
â”‚   â”‚   â””â”€â”€ api/routes.go
â”‚   â””â”€â”€ migrations/
â”‚
â”œâ”€â”€ tokenization-service/
â”‚   â”œâ”€â”€ cmd/main.go
â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â”œâ”€â”€ models/ âœ…
â”‚   â”‚   â”œâ”€â”€ repository/ âœ…
â”‚   â”‚   â”œâ”€â”€ service/ âœ…
â”‚   â”‚   â”œâ”€â”€ crypto/ âœ…
â”‚   â”‚   â”œâ”€â”€ validation/ âœ…
â”‚   â”‚   â”œâ”€â”€ handler/ â³
â”‚   â”‚   â”œâ”€â”€ middleware/ â³
â”‚   â”‚   â”œâ”€â”€ grpc/ â³
â”‚   â”‚   â””â”€â”€ api/routes.go â³
â”‚   â””â”€â”€ migrations/ â³
â”‚
â”œâ”€â”€ payment-api-service/ â³
â”œâ”€â”€ transaction-service/ â³
â”œâ”€â”€ fraud-detection-service/ â³
â””â”€â”€ card-simulator-service/ â³
```

---

## ğŸš€ Current Task

**Implementing Tokenization Service handlers and middleware**

**Decisions made:**
- âœ… Error format: Specific errors (better DX)
- âœ… Idempotency: Yes, using Redis
- âœ… Internal communication: gRPC
- âœ… CVV: Validated but never stored
- âœ… Response format: Detailed (with card metadata)

**Next steps:**
1. Build REST API handlers (public endpoints)
2. Build gRPC handlers (internal endpoints)
3. Implement middleware (auth, rate limit, logging)
4. Setup routes
5. Write tests

---

## ğŸ“ Environment Variables
```env
# Database
DATABASE_DSN=postgresql://user:pass@localhost:5432/tokenization_db

# Redis
REDIS_DSN=redis://localhost:6379/0

# Vault
VAULT_ENABLED=false  # true for production
VAULT_ADDR=http://localhost:8200
VAULT_TOKEN=your-vault-token

# JWT
JWT_SECRET_KEY=your-jwt-secret

# Server
PORT=8003
GIN_MODE=release
```

---

## ğŸ¯ Key Concepts

### **Terminology:**
- **Merchant:** Business using the payment gateway
- **Buyer:** Customer paying through merchant's site
- **PAN:** Primary Account Number (full card number)
- **Token:** Non-sensitive reference to card (tok_live_xxx)
- **BIN:** Bank Identification Number (first 6 digits)
- **DEK:** Data Encryption Key (per-merchant key)
- **KEK:** Key Encryption Key (master key in Vault)

### **Transaction Types:**
- **Authorize:** Hold funds (not charged yet)
- **Sale:** Authorize + Capture (immediate charge)
- **Capture:** Charge held funds
- **Void:** Cancel authorization
- **Refund:** Return funds to buyer

---

## âš ï¸ Important Notes

1. **CVV is NEVER stored** - Only validated during tokenization
2. **Full PAN is NEVER logged** - Only last 4 digits or masked
3. **Each merchant has own encryption key** - Multi-tenant security
4. **Keys rotate every 90 days** - Or after 1M encryptions
5. **Tokens can be single-use** - Extra security for one-time payments
6. **Duplicate cards return existing token** - Prevents redundant storage

---

## ğŸ“š Useful Commands
```bash
# Start Auth Service
cd auth-service
air

# Start Merchant Service  
cd merchant-service
air

# Start Tokenization Service
cd tokenization-service
air

# Run migrations
go run internal/migrations/migrate.go

# Run tests
go test ./internal/... -v -cover
```

---

This README should be provided at the start of every new AI chat session for context.